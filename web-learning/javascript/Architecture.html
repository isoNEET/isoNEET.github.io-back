<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>4. JavaScript引擎架構 - Web Study Notes</title>

        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <meta property="og:title" content="isoNEET - Web 教材" />
        <meta property="og:image" content="https://isoneet.org/isoneet.png" />
        <meta property="og:url" content="https://isoneet.org/web-learning/index.html" />


        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/atom-one-dark.min.css">
        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href="../././mdbook-admonish.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">yhchen.space@gmail.com</li><li class="chapter-item expanded "><a href="../Introduce.html"><strong aria-hidden="true">1.</strong> 介紹</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> 開發工具</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../devTools/git.html"><strong aria-hidden="true">2.1.</strong> Git</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> Visual Studio Code</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">JavaScript Core</li><li class="chapter-item expanded "><a href="../javascript/Overview.html"><strong aria-hidden="true">3.</strong> 概觀</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../javascript/Syntax.html"><strong aria-hidden="true">3.1.</strong> 1. 語法速覽</a></li><li class="chapter-item expanded "><a href="../javascript/Types.html"><strong aria-hidden="true">3.2.</strong> 2. 深入型別系統</a></li><li class="chapter-item expanded "><a href="../javascript/Object.html"><strong aria-hidden="true">3.3.</strong> 3. 物件與類別</a></li><li class="chapter-item expanded "><a href="../javascript/Architecture.html" class="active"><strong aria-hidden="true">3.4.</strong> 4. JavaScript引擎架構</a></li><li class="chapter-item expanded "><a href="../javascript/Asynchronous.html"><strong aria-hidden="true">3.5.</strong> 5. 非同步程式設計</a></li><li class="chapter-item expanded "><a href="../javascript/Common-skill.html"><strong aria-hidden="true">3.6.</strong> 6. 常用技巧與函數</a></li><li class="chapter-item expanded "><a href="../javascript/Conclusion.html"><strong aria-hidden="true">3.7.</strong> 7. 總結</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">TypeScript</li><li class="chapter-item expanded "><a href="../typescript/Overview.html"><strong aria-hidden="true">4.</strong> 概觀</a></li><li class="chapter-item expanded affix "><li class="part-title">RESTful API 相關知識</li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> </div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sections/related-work/HTTP.html"><strong aria-hidden="true">5.1.</strong> 1. HTTP 協定</a></li><li class="chapter-item expanded "><a href="../sections/related-work/URL.html"><strong aria-hidden="true">5.2.</strong> 2. URL</a></li><li class="chapter-item expanded "><a href="../sections/related-work/API.html"><strong aria-hidden="true">5.3.</strong> 3. API 與 RESTful API</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Web Study Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="javascript-架構"><a class="header" href="#javascript-架構">JavaScript 架構</a></h1>
<p>在這個章節，會先說明非同步程式的概念，假設有個程式這樣寫：</p>
<pre><code class="language-js">const arr = [];
arr.push(1);
arr.push(2);
arr.push(3);
arr.push(4);
console.log(arr) // [1,2,3,4]
</code></pre>
<p>在這個例子中，程式碼都是由上到下執行，因此很好預測執行結果
但如果程式碼改成以下模式：</p>
<pre><code class="language-js">
const arr = []
let fileA = download(urlA);
let fileB = download(urlB);
let fileC = download(urlC);

while( !(fileA.done &amp;&amp; fileB.done &amp;&amp; fileC.done) ) {
  if(fileA.done &amp;&amp; !fileA.lock) {
    arr.push(fileA.content);
    fileA.writeLock();
  }
  if(fileB.done &amp;&amp; !fileB.lock) {
    arr.push(fileB.content);
    fileB.writeLock();
  }
  if(fileC.done &amp;&amp; !fileC.lock) {
    arr.push(fileC.content);
    fileC.writeLock();
  }
}
</code></pre>
<p>假設有個想像的程式碼，會下載三個網站的內容，並有個迴圈檢測是否下載完成；如果有任何網站還未下載完成，就不會離開迴圈</p>
<p>迴圈會依序檢查A、B、C的內容，若下載完成後，把資料放入<code>arr</code>中，並且上鎖防止重複寫入</p>
<p>有個關鍵的問題是：<code>arr</code>中資料的順序為何 ？無從得知</p>
<p>或許可以改成： <code>arr[0] = fileA.content</code>這種做法來確定資料的順序，但是這不切實際</p>
<p>比方說需要先登入銀行、然後才能操作帳戶，操作順序有時序性；當步驟越來越繁瑣</p>
<p>無法確定API回傳順序時，這依舊是個難題 - 在網路世界中，資料未必能照你的想法依序取得</p>
<h2 id="javascript-引擎架構"><a class="header" href="#javascript-引擎架構">JavaScript 引擎架構</a></h2>
<p><img src="./images/js-v8.png" alt="v8" /></p>
<p>在解釋上方的架構圖之前，先模擬一個情境：
在 C++ 中，可能使用 <code>cin</code> 或是 <code>scanf</code> 來得到使用者的輸入，若程式碼如下：</p>
<pre><code class="language-cpp">cin &gt;&gt; num;
cout &lt;&lt; &quot;Hello, world&quot; &lt;&lt; endl;
</code></pre>
<p>cin 會嘗試取得使用者輸入，然後輸出 &quot;Hello, world&quot;。但是使用者輸入之前，畫面是<strong>不會</strong>繼續渲染的，這在交互式的 command interface 不是問題，但是到了 GUI 卻相當嚴重；
比方說登入頁面，在你輸入帳號、密碼之前，畫面上其他部分都停止繪製，這聽起來很可怕對嗎？
因此瀏覽器採用的做法是&quot;事件驅動&quot;，透過觀察者模式 <em>(設計模式的一種，不贅述)</em>，等待用戶發出的事件，並進行響應</p>
<p>比方說</p>
<pre><code class="language-html">&lt;button onclick=&quot;alert('My name is Alex')&quot;&gt;Click Me&lt;/button&gt;
</code></pre>
<p>當點下按鈕後，會push <code>clickEvent</code> 至事件佇列(Event Queue)，觀察 EventLoop，他是一個無窮迴圈，會不斷檢查事件佇列，若裡頭有資料，生成Task給後面的執行緒</p>
<p>這就是關鍵所在，因為不知道使用者何時輸入/點擊畫面，因此需要用某種機制來控制渲染的執行緒、網路請求執行緒、JS執行緒，讓他們在正確的時間點運作</p>
<p>有了這個概念，再追加補充：JavaScript有分成 <code>main thread</code> 與 <code>job thread</code>(或者說是 worker, task thread)，而所有的非同步事件會先扔至 <code>job thread</code>，靜待瀏覽器調用</p>
<p>比方說 <code>setTimeout(fn, ms)</code>，接受一個function和毫秒的數值，就會在 N 毫秒後調用該方法</p>
<pre><code class="language-js">setTimeout(() =&gt; console.log('test'), 1000) // 1秒後印出 'test'
</code></pre>
<p>實際上的原理如下(大致上相同)：</p>
<ol>
<li>一開始，瀏覽器會初始化一個 timer，紀錄經過的毫秒數</li>
<li>呼叫<code>setTimeout</code>時，放置一個事件在 <code>job thread</code></li>
<li>每次 Eventloop 的週期，把<code>main thread</code>的工作結束後，檢查<code>job thread</code></li>
<li>如果<code>job thread</code>裡面有事件，檢查註冊的時戳，並比較<code>Now() - timestamp</code>是不是已經逾時了</li>
<li>如果上述為真，代表事件應該要執行了，調用它</li>
<li>回到步驟3</li>
</ol>
<p>比方說設定了 <code>setTimeout(fn, 1000)</code>, 此時註冊是時間是12:00:00，當12:00:01時，相減得到 1000， <code>1000 &gt;= 1000</code>，調用 fn</p>
<p>假設有個情境如下：要輸出1 ~ 5，每一秒輸出一個數字，程式設計如下：</p>
<pre><code class="language-js">setTimeout(() =&gt; console.log(1), 1000);
setTimeout(() =&gt; console.log(2), 2000);
setTimeout(() =&gt; console.log(3), 3000);
setTimeout(() =&gt; console.log(4), 4000);
setTimeout(() =&gt; console.log(5), 5000);
</code></pre>
<p>這時候，&quot;好像&quot;跟預期的一樣，但是要證明幾點：</p>
<p>首先，如何證明<code>main thread結束後，才會執行job thread的工作</code>？
證明如下：已知<code>setTimeout</code>會把事件放入job thread，那可以先設定<code>setTimeout(fn, 0)</code>;</p>
<pre><code class="language-js">let arr = [];
setTimeout(() =&gt; arr.push(1), 0); // job thread
setTimeout(() =&gt; arr.push(2), 0); // job thread
setTimeout(() =&gt; arr.push(3), 0); // job thread
arr.push(4) // main thread
console.log(arr) // [4,1,2,3]
</code></pre>
<p>這個程式碼的意義是：因為前面三次push是放在<code>job thread</code>的，因此狀況就好像：</p>
<pre><code class="language-js">JobThread = [fn, fn, fn];
MainThread = [fn];
</code></pre>
<p>必須等到 <code>MainThread</code> 清空後，才會依序執行 <code>job thread</code> 內的工作</p>
<p>其次，<code>每次loop都會去檢查時戳，決定要不要執行job</code>這個描述有點模糊，應該這樣說：
<code>setTimeout</code> 如果設定 ms = 1000，<code>是1000毫秒後執行</code>，還是<code>至少1000毫秒後</code>執行，這個證明有兩個方法：</p>
<p>首先定義基準時間：</p>
<p><img src="./images/timer.png" alt="timer" /></p>
<!-- markdownlint-disable MD033 -->
<p>在我的電腦上，執行 3 * 10<sup>9</sup>次 空迴圈大約耗時 1500ms，接下來分別推入5個事件到<code>job thread</code>中：</p>
<p>使用 <code>performance.now</code>取得分頁開啟後的累積時間，並透過 <code>setTimeout</code> 放入 <code>job thread</code></p>
<p><img src="./images/timer2.png" alt="timer2" /></p>
<p>測試方法如下：先定義 <code>diffTime</code>，他會計算陣列前後項的時間差，相當於是 <code>setTimeout</code> 放入時戳的差值</p>
<p>首先定義五個 job，都是放入一個時戳到<code>timestamps[]</code>中，最後手動呼叫 <code>diffTime</code></p>
<p>可以看到每一次的時間間隔大概是 90~100ms 左右</p>
<p>接下來設計一個實驗：</p>
<pre><code class="language-js">function diffTime(arr) {
  for(let i = 0; i &lt; arr.length - 1 ; ++i) {
    console.log(`time pass: ${arr[i+1] - arr[i]} ms`);
  }
}

// 放入5個 Task 到 job thread 中
let timestamps = [];
setTimeout(() =&gt; { timestamps.push(performance.now())}, 100);
setTimeout(() =&gt; { timestamps.push(performance.now())}, 200);
setTimeout(() =&gt; { timestamps.push(performance.now())}, 300);
setTimeout(() =&gt; { timestamps.push(performance.now())}, 400);
setTimeout(() =&gt; { timestamps.push(performance.now())}, 500);

// 使用 for-loop，阻塞 main thread 1500ms 左右
console.time(&quot;timer&quot;)
for(let i = 0 ; i &lt; 3 * 1e9 ; ++i) {}
console.timeEnd(&quot;timer&quot;)

// diffTime(timestamps) 最後手動呼叫，查看每個元素被放入的時間差
</code></pre>
<div style="display:flex; justify-content: center;">
  <img src="./images/timer3.png" />
</div>
<p>這個結果的意義是：</p>
<ul>
<li>假定在 <code>t0</code> 的時候執行腳本</li>
<li>分別設定事件：放入時戳到 <code>timestamps</code> 中，分別在 <code>t0 + (100 ~ 500)ms</code> 的5個時間點</li>
<li>然後腳本繼續往下，使用 <code>for-loop</code> 阻塞 <code>main thread</code> 1492ms</li>
<li>在 <code>t0 + 1492ms</code> 的時間點後，清空 <code>main thread</code> 的所有操作</li>
<li>此時檢查 <code>job thread</code> 中的 task，發現 5 個 Task 都逾時了</li>
<li>依序執行 5 個 Task</li>
</ul>
<p>也許有點複雜，但是想驗證的核心概念：<strong>唯有當 main thread 執行結束後，才會執行job thread 中的Task</strong>已被證明</p>
<p>另外還有兩個單純的測試方法：</p>
<p>首先執行，會看到大約每間隔一秒，畫面會輸出一個數字</p>
<pre><code class="language-js">setTimeout(() =&gt; console.log(1), 1000);
setTimeout(() =&gt; console.log(2), 2000);
setTimeout(() =&gt; console.log(3), 3000);
setTimeout(() =&gt; console.log(4), 4000);
setTimeout(() =&gt; console.log(5), 5000);
</code></pre>
<p>接下來改成執行：</p>
<pre><code class="language-js">setTimeout(() =&gt; console.log(1), 1000);
setTimeout(() =&gt; console.log(2), 2000);
setTimeout(() =&gt; console.log(3), 3000);
setTimeout(() =&gt; console.log(4), 4000);
setTimeout(() =&gt; console.log(5), 5000);
window.alert('block!');
</code></pre>
<p><code>alert</code> 會跳出一個提示框，他會強制阻塞<code>main thread</code>，等到5秒後把提示框給點掉</p>
<p><img src="./images/alert.png" alt="alert" /></p>
<p>然後再看看 <code>console.log</code> 的輸出，會發現1~5會<strong>同時</strong>輸出；</p>
<p>還有一個非常簡單暴力的作法：</p>
<pre><code class="language-js">while(true) {}
setTimeout(() =&gt; console.log(), 0); // 永不執行，因為 main thread 被 while-loop 永遠阻塞
</code></pre>
<h2 id="關於-settimeout-或-setinterval"><a class="header" href="#關於-settimeout-或-setinterval">關於 setTimeout 或 setInterval</a></h2>
<p>前述的例子中，有點像是證明 <code>main thread</code> 與 <code>job thread</code> 的關係，如果只是證明：setTimeout和setInterval 是至少 N 毫秒後執行</p>
<p>可以透過 console.time 和 console.timeEnd 兩組函數，觀測瀏覽器回傳的時間差異</p>
<p><img src="./images/timer4.png" alt="alert" /></p>
<p>如圖所示，計時開始與結束的時間是 1019ms，實際上與 1000ms 還是有一點誤差</p>
<h2 id="章節回顧"><a class="header" href="#章節回顧">章節回顧</a></h2>
<p>本節提到幾個點：事件驅動與非同步程式設計，並以下載資料為例子，指出了在網路程式設計中，有無法預測的部分</p>
<p>比方說檔案下載完成的順序、硬碟讀取完成的時間點等</p>
<p>為了鋪陳下個章節<code>非同步程式設計</code>，該章節花了滿大的篇幅說明JS的內部架構</p>
<ul>
<li>對於<code>非同步</code>有基礎的認識</li>
<li>能夠理解事件驅動的概念</li>
<li>能夠理解 JS 中的 <code>main thread</code> 與 <code>job thread</code></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../javascript/Object.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../javascript/Asynchronous.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../javascript/Object.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../javascript/Asynchronous.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
